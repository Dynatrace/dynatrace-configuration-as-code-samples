{
  "displayName": "{{.pipelineDisplayName}}",
  "customId": "{{.pipelineCustomName}}",
  "processing": {
    "processors": [
      {
        "id": "processor_add_argocd_deployment_properties",
        "type": "dql",
        "matcher": "isNotNull(app)",
        "description": "Add ArgoCD deployment properties",
        "enabled": true,
        "dql": {
          "script": "parse app, \n  \"JSON{\n    JSON{\n      JSON{\n        STRING:phase,\n        STRING:finishedAt,\n        STRING:startedAt,\n        JSON{\n          JSON{\n            STRING:targetRevision,\n            STRING:repoURL\n          }:source\n        }:syncResult,\n        JSON{\n          JSON{\n            STRING:revision\n          }:sync\n        }:operation,\n        STRING:message\n      }:operationState,\n      JSON{\n        STRING:revision,\n        JSON{\n          JSON{\n            STRING:namespace,\n            STRING:server,\n            STRING:name\n          }:destination\n        }:comparedTo,\n        STRING:status\n      }:sync,\n      JSON{\n        STRING[]:images,\n        STRING[]:externalURLs\n      }:summary,\n      JSON{\n        STRING:status\n      }:health,\n      JSON[]:conditions,\n      STRING:reconciledAt\n    }:status,\n    JSON{\n      STRING:uid,\n      STRING:namespace,\n      STRING:resourceVersion,\n      JSON:labels,\n      STRING:name\n    }:metadata,\n    JSON{\n      STRING:project\n    }:spec\n  }:app_json\" \n| fieldsFlatten app_json, fields:{ status, metadata, spec } \n\n| fieldsAdd event.status = if(lower(status[operationState][phase]) == \"running\", \"started\", else: \"finished\")\n| fieldsAdd duration = if((status[operationState][finishedAt] > status[operationState][startedAt]) and isNotNull(status[operationState][finishedAt]), toTimestamp(status[operationState][finishedAt]) - toTimestamp(status[operationState][startedAt]), else: toDuration(0))\n| fieldsAdd start_time = status[operationState][startedAt]\n| fieldsAdd end_time = status[operationState][finishedAt]\n\n| fieldsAdd task.id = hashSha1(concat(toString(toLong(now())), toString(RANDOM())))\n| fieldsAdd task.name = \"ArgoCD Deployment\"\n| fieldsAdd task.outcome = lower(status[operationState][phase])\n\n| fieldsAdd vcs.ref.base.name = status[operationState][syncResult][source][targetRevision]\n| fieldsAdd vcs.ref.base.revision = status[operationState][operation][sync][revision]\n| fieldsAdd vcs.repository.url.full = status[operationState][syncResult][source][repoURL]\n| fieldsAdd repository_http_url = if (contains(vcs.repository.url.full, \"git@\" ), replaceString(replaceString(vcs.repository.url.full, \"git@github.com:\", \"http://github.com/\"), \".git\", \"\"), else: vcs.repository.url.full)\n| fieldsAdd vcs.repository.commit.url = concat(repository_http_url, \"/commit/\", vcs.ref.base.revision)\n\n| fieldsAdd cicd.deployment.service.id = metadata[uid]\n| fieldsAdd deployment.service.namespace = metadata[namespace]\n| fieldsAdd deployment.service.resource_version = metadata[resourceVersion]\n| fieldsAdd deployment.service.labels = metadata[labels]\n\n| fieldsAdd cicd.deployment.id = status[sync][revision]\n| fieldsAdd cicd.deployment.name = metadata[name]\n| fieldsAdd cicd.deployment.namespace = status[sync][comparedTo][destination][namespace]\n| fieldsAdd deployment.environment.name = \"undefined\"\n| fieldsAdd cicd.deployment.server.url.full = if(isNotNull(status[sync][comparedTo][destination][server]), status[sync][comparedTo][destination][server], else: if(isNotNull(status[sync][comparedTo][destination][name]), status[sync][comparedTo][destination][name]))\n| fieldsAdd deployment.images = status[summary][images]\n\n| fieldsAdd argocd.app.health.status = lower(status[health][status])\n| fieldsAdd argocd.app.conditions = status[conditions]\n| fieldsAdd argocd.app.reconciliation.time =  toTimeStamp(status[reconciledAt])\n| fieldsAdd argocd.sync.status = lower(status[sync][status])\n| fieldsAdd argocd.sync.operation_state.outcome = lower(status[operationState][message])\n\n| fieldsAdd argocd.app.project.name = spec[project]\n\n| fieldsAdd argocd.app.name = metadata[labels][app]\n| fieldsAdd argocd.app.stage = metadata[labels][stage]\n| fieldsAdd argocd.app.owner = metadata[labels][owner]\n| fieldsAdd argocd.app.version = metadata[labels][version]\n\n| fieldsAdd deployment.ingress.url = status[summary][externalURLs][0]\n| fieldsAdd cicd.deployment.release_stage = argocd.app.stage\n| fieldsAdd deployment.release.product = concat(argocd.app.project.name, \"-\", argocd.app.owner)\n| fieldsAdd deployment.release.version = argocd.app.version\n\n| fieldsRemove app_json, status, metadata, spec, repository_http_url"
        }
      },
      {
        "id": "processor_add_argocd_app_url",
        "type": "dql",
        "matcher": "isNotNull(context)",
        "description": "Add ArgoCD app URL",
        "enabled": true,
        "dql": {
          "script": "parse context, \n  \"JSON{\n    STRING:argocdURL\n  }:ctx_json\" \n| fieldsFlatten ctx_json, fields:{argocdUrl}\n\n| fieldsAdd argocd.app.url = concat(argocdUrl, \"/applications/\", deployment.service.namespace, \"/\", cicd.deployment.name)\n\n| fieldsRemove ctx_json, argocdUrl"
        }
      },
      {
        "id": "processor_clean_up",
        "type": "fieldsRemove",
        "matcher": "true",
        "description": "Clean up",
        "enabled": true,
        "fieldsRemove": {
          "fields": [
            "app",
            "context"
          ]
        }
      }
    ]
  },
  "metricExtraction": {
    "processors": [
      {
        "id": "metric_processor_number_of_finished_sdlc_tasks",
        "type": "counterMetric",
        "matcher": "event.status == \"finished\"",
        "description": "Number of finished SDLC tasks",
        "enabled": true,
        "counterMetric": {
          "metricKey": "events.sdlc.finished_tasks",
          "dimensions": [
            {
              "extractionType": "field",
              "sourceFieldName": "event.category"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "event.type"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "event.provider"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "event.status"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "vcs.repository.ref.name"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "cicd.pipeline.name"
            }
          ]
        }
      },
      {
        "id": "metric_processor_number_of_all_sdlc_tasks",
        "type": "counterMetric",
        "matcher": "true",
        "description": "Number of all SDLC tasks",
        "enabled": true,
        "counterMetric": {
          "metricKey": "events.sdlc.tasks",
          "dimensions": [
            {
              "extractionType": "field",
              "sourceFieldName": "event.category"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "event.type"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "event.provider"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "event.status"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "vcs.repository.ref.name"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "cicd.pipeline.name"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "actor.geo.country.name"
            }
          ]
        }
      },
      {
        "id": "metric_processor_duration_of_finished_sdlc_tasks",
        "type": "valueMetric",
        "matcher": "event.status == \"finished\"",
        "description": "Duration of finished SDLC tasks",
        "enabled": true,
        "valueMetric": {
          "metricKey": "events.sdlc.task_duration",
          "field": "duration",
          "dimensions": [
            {
              "extractionType": "field",
              "sourceFieldName": "event.category"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "event.type"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "event.provider"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "event.status"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "vcs.repository.ref.name"
            },
            {
              "extractionType": "field",
              "sourceFieldName": "cicd.pipeline.name"
            }
          ]
        }
      }
    ]
  }
}
